trigger:
- master

pool:
  name: Default  # your self-hosted Mac agent

variables:
  imageName: sample-pipeline-demo
  artifactoryUrl: 'https://soddiraju.jfrog.io'        # e.g. myrepo.jfrog.io
  artifactoryRepo: 'devops9-docker'     # e.g. docker-local
  
stages:
# -----------------------------
# Stage 1: Build Docker image
# -----------------------------
- stage: Build
  displayName: Build Docker Image
  jobs:
  - job: Build
    steps:
    - task: Docker@2
      displayName: Build Docker image
      inputs:
        command: build
        Dockerfile: '**/Dockerfile'
        tags: |
          $(imageName):$(Build.BuildId)

# -----------------------------
# Stage 2: Run & Test the Image
# -----------------------------
- stage: Test
  displayName: Run Docker Image and Print Output
  dependsOn: Build
  jobs:
  - job: Test
    steps:
    - script: |
        echo "Running image locally..."
        docker run --rm $(imageName):$(Build.BuildId)
      displayName: Run container and print output

# -----------------------------
# Stage 3: Publish to Artifactory
# -----------------------------
- stage: Publish
  displayName: Push Docker Image to JFrog Artifactory
  dependsOn: Test
  jobs:
  - job: Push
    steps:
    - script: |
        echo "Logging in to JFrog Artifactory..."
        echo "$(artifactoryPassword)" | docker login $(artifactoryUrl) -u "$(artifactoryUser)" --password-stdin

        echo "Tagging image for Artifactory..."
        docker tag $(imageName):$(Build.BuildId) $(artifactoryUrl)/$(artifactoryRepo)/$(imageName):$(Build.BuildId)

        echo "Pushing image to Artifactory..."
        docker push $(artifactoryUrl)/$(artifactoryRepo)/$(imageName):$(Build.BuildId)
      displayName: Push image to Artifactory
